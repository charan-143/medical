{% extends "base.html" %}

{% block title %}Medical Records - Medical Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Medical Records</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="fas fa-upload me-2"></i> Upload Document
        </button>
    </div>
    
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.records') }}">Home</a></li>
            {% if current_folder %}
                {% for folder in folder_path %}
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.records', folder_id=folder.id) }}">{{ folder.name }}</a></li>
                {% endfor %}
                <li class="breadcrumb-item active" aria-current="page">{{ current_folder.name }}</li>
            {% endif %}
        </ol>
    </nav>
    
    <!-- Folder/File View -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="mb-0">Documents</h5>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search records...">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- New Folder Button -->
            <div class="mb-3">
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                    <i class="fas fa-folder-plus me-2"></i> New Folder
                </button>
            </div>
            
            <!-- Folders and Files -->
            <div class="folder-container">
                <!-- Folders -->
                {% if subfolders %}
                    {% for folder in subfolders %}
                        <a href="{{ url_for('dashboard.records', folder_id=folder.id) }}" class="text-decoration-none">
                            <div class="folder-item">
                                <div class="folder-icon">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <div class="folder-name">{{ folder.name }}</div>
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    {% if not documents %}
                        <div class="text-muted text-center my-3">
                            <p>No folders found in this location</p>
                        </div>
                    {% endif %}
                {% endif %}
                
                <!-- Documents -->
                {% if documents %}
                    {% for document in documents %}
                        <div class="file-item">
                            <div class="file-icon">
                                {% if document.file_type.lower() == 'pdf' %}
                                    <i class="fas fa-file-pdf"></i>
                                {% elif document.file_type.lower() in ['jpg', 'jpeg', 'png', 'gif'] %}
                                    <i class="fas fa-file-image"></i>
                                {% elif document.file_type.lower() in ['doc', 'docx'] %}
                                    <i class="fas fa-file-word"></i>
                                {% elif document.file_type.lower() in ['xls', 'xlsx'] %}
                                    <i class="fas fa-file-excel"></i>
                                {% else %}
                                    <i class="fas fa-file"></i>
                                {% endif %}
                            </div>
                            <div class="file-name">{{ document.original_filename }}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    {% if not subfolders %}
                        <div class="text-muted text-center my-3">
                            <p>No files found in this location</p>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- New Folder Modal -->
<div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newFolderModalLabel">Create New Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('dashboard.create_folder') }}">
                    <div class="mb-3">
                        <label for="folder_name" class="form-label">Folder Name</label>
                        <input type="text" class="form-control" id="folder_name" name="folder_name" required>
                    </div>
                    {% if current_folder %}
                        <input type="hidden" name="parent_id" value="{{ current_folder.id }}">
                    {% endif %}
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Create Folder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentPreviewModalLabel">Document Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="document-preview">
                    <!-- Document will be displayed here -->
                    <div class="text-center">
                        <img src="#" alt="Document Preview" id="previewImage" class="img-fluid d-none">
                        <iframe id="previewPdf" src="#" width="100%" height="500px" class="d-none"></iframe>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Download</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
{% if current_user.is_authenticated %}
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Upload Medical Records</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" action="{{ url_for('dashboard.upload_json') }}" method="post" enctype="multipart/form-data">
                    <!-- Hidden field for folder ID, populated when folder is created -->
                    <input type="hidden" id="uploadFolderId" name="folder_id" value="{{ current_folder.id if current_folder else '' }}">
                    <!-- CSRF token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <!-- Folder Name Input -->
                    <div class="mb-4">
                        <label class="form-label">Folder Name</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-folder-plus text-primary"></i>
                            </span>
                            <input type="text" class="form-control" id="newFolderName" name="folder_name" 
                                placeholder="Enter folder name for these files" required>
                        </div>
                        <small class="text-muted mt-1">
                            A new folder with this name will be created and all files will be uploaded to it
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description (optional)</label>
                        <input type="text" class="form-control" id="description" name="description" placeholder="Brief description of the files">
                    </div>
                    <div class="mb-3">
                        <div id="dragDropArea" class="drag-drop-area">
                            <div class="drag-drop-message text-center p-5">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                                <h5>Drag & Drop Files Here</h5>
                                <p class="text-muted mb-3">or</p>
                                <label for="recordFiles" class="btn btn-outline-primary">
                                    Browse Files
                                </label>
                                <input type="file" class="d-none" id="recordFiles" name="files[]" multiple>
                                <p class="mt-2 small text-muted">Upload multiple files (max 10MB each)</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Preview Area -->
                    <div id="filePreviewContainer" class="file-preview-container mb-3 d-none">
                        <h6 class="mb-3">Files to Upload (<span id="fileCount">0</span>)</h6>
                        <div id="fileList" class="file-list"></div>
                        
                        <!-- Overall Progress Bar -->
                        <div class="mt-3 d-none" id="overallProgressContainer">
                            <label class="form-label d-flex justify-content-between">
                                <span>Overall Progress</span>
                                <span id="overallProgressPercent">0%</span>
                            </label>
                            <div class="progress">
                                <div id="overallProgressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Messages -->
                    <div id="uploadMessages" class="alert d-none mb-3"></div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="removeAllFiles" class="btn btn-outline-danger d-none">Remove All</button>
                        <button type="submit" id="uploadButton" class="btn btn-primary">Upload Files</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all modals
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modalEl => {
        // Let Bootstrap's data-api handle initialization
        console.log('Found modal:', modalEl.id);
    });
    
    // Handle new folder form submission
    const newFolderForm = document.querySelector('#newFolderModal form');
    if (newFolderForm) {
        newFolderForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('New folder form submitted');
            
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newFolderModal'));
                    if (modal) modal.hide();
                    
                    // Reload the page to show new folder
                    window.location.reload();
                } else {
                    alert(data.message || 'Failed to create folder');
                }
            })
            .catch(error => {
                console.error('Error creating folder:', error);
                alert('Error creating folder. Please try again.');
            });
        });
    }
    
    const uploadModal = document.getElementById('uploadModal');
    
    // File upload initialization code
    if (uploadModal) {
        console.log('Upload modal found, initializing...');
        
        // Elements
        const uploadForm = document.getElementById('uploadForm');
        const dragDropArea = document.getElementById('dragDropArea');
        const fileInput = document.getElementById('recordFiles');
        const filePreviewContainer = document.getElementById('filePreviewContainer');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const uploadButton = document.getElementById('uploadButton');
        const removeAllBtn = document.getElementById('removeAllFiles');
        const uploadMessages = document.getElementById('uploadMessages');
        const overallProgressContainer = document.getElementById('overallProgressContainer');
        const overallProgressBar = document.getElementById('overallProgressBar');
        const overallProgressPercent = document.getElementById('overallProgressPercent');
        
        // Variables for tracking files
        let selectedFiles = [];
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        const ALLOWED_TYPES = [
            'image/jpeg', 'image/png', 'image/gif', 
            'application/pdf', 'application/msword', 
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.ms-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        ];
        
        // Setup drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dragDropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dragDropArea.classList.remove('highlight');
        }
        
        // Handle dropped files
        dragDropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        // Handle files from file input
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                console.log('Files selected via input:', this.files.length);
                handleFiles(this.files);
                
                // Force enable upload button if files are selected
                if (this.files.length > 0) {
                    uploadButton.disabled = false;
                }
            }
        });

        // Process selected files
        function handleFiles(files) {
            if (!files || !files.length) {
                console.log('No files to process');
                return;
            }
            
            console.log('Processing', files.length, 'files');
            
            // Add new files to our array
            Array.from(files).forEach(file => {
                // Check if file is valid
                const validationResult = validateFile(file);
                if (validationResult.valid) {
                    // Add to selected files if not already present (check by name for simplicity)
                    if (!selectedFiles.some(f => f.name === file.name)) {
                        console.log('Adding file:', file.name);
                        selectedFiles.push(file);
                    } else {
                        console.log('File already selected:', file.name);
                    }
                } else {
                    // Show error message for invalid file
                    showMessage(validationResult.message, 'warning');
                }
            });
            
            // Update the UI
            updateFileList();
            // Force update upload button state
            updateUploadButtonState();
            console.log('Total selected files:', selectedFiles.length);
        }

        // Validate file type and size
        function validateFile(file) {
            // Check file size
            if (file.size > MAX_FILE_SIZE) {
                return {
                    valid: false,
                    message: `File "${file.name}" exceeds the maximum size of 10MB`
                };
            }
            
            // Check file type (optional, based on allowed types)
            if (ALLOWED_TYPES.length > 0 && !ALLOWED_TYPES.includes(file.type)) {
                return {
                    valid: false,
                    message: `File "${file.name}" has an unsupported file type`
                };
            }
            
            return { valid: true };
        }
        
        // Update the file list display
        function updateFileList() {
            // Clear the current list
            fileList.innerHTML = '';
            fileCount.textContent = selectedFiles.length;
            
            console.log('Updating file list with', selectedFiles.length, 'files');
            
            // Show/hide elements based on file selection
            if (selectedFiles.length > 0) {
                console.log('Enabling upload button');
                filePreviewContainer.classList.remove('d-none');
                removeAllBtn.classList.remove('d-none');
                uploadButton.disabled = false;
            } else {
                console.log('Disabling upload button');
                filePreviewContainer.classList.add('d-none');
                removeAllBtn.classList.add('d-none');
                uploadButton.disabled = true;
            }
            
            // Add file items
            selectedFiles.forEach((file, index) => {
                console.log('Creating list item for file:', file.name);
                const fileItem = createFileItem(file, index);
                fileList.appendChild(fileItem);
            });
            
            // Force enable upload button if we have files
            if (selectedFiles.length > 0) {
                uploadButton.disabled = false;
            }
        }
        
        // Create a file item for the preview list
        function createFileItem(file, index) {
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            // Create file item element
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item mb-2 p-2 border rounded d-flex align-items-center';
            
            // File icon based on type
            let iconClass = 'fa-file';
            if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                iconClass = 'fa-file-image';
            } else if (fileExt === 'pdf') {
                iconClass = 'fa-file-pdf';
            } else if (['doc', 'docx'].includes(fileExt)) {
                iconClass = 'fa-file-word';
            } else if (['xls', 'xlsx'].includes(fileExt)) {
                iconClass = 'fa-file-excel';
            }
            
            // Calculate human-readable file size
            const fileSize = formatFileSize(file.size);
            
            // File preview (thumbnail for images)
            let previewElement = '';
            if (file.type.startsWith('image/')) {
                previewElement = `
                    <div class="file-thumbnail me-2">
                        <img src="${URL.createObjectURL(file)}" alt="${file.name}" class="img-thumbnail" style="width: 40px; height: 40px; object-fit: cover;">
                    </div>
                `;
            } else {
                previewElement = `
                    <div class="file-icon me-2">
                        <i class="fas ${iconClass} fa-2x text-secondary"></i>
                    </div>
                `;
            }
            
            // Build the file item HTML
            fileItem.innerHTML = `
                ${previewElement}
                <div class="file-info flex-grow-1">
                    <div class="file-name text-truncate">${file.name}</div>
                    <div class="file-size small text-muted">${fileSize}</div>
                </div>
                <div class="file-progress d-none">
                    <div class="progress" style="width: 60px; height: 6px;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <button type="button" class="btn-close ms-2 remove-file" data-index="${index}" aria-label="Remove file"></button>
            `;
            
            // Add event listener for remove button
            fileItem.querySelector('.remove-file').addEventListener('click', function() {
                removeFile(this.getAttribute('data-index'));
            });
            
            return fileItem;
        }
        
        // Remove a file from the selection
        function removeFile(index) {
            console.log('Removing file at index:', index);
            selectedFiles.splice(index, 1);
            updateFileList();
            updateUploadButtonState();
        }

        // Format file size to human-readable format
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Remove all files
        removeAllBtn.addEventListener('click', function() {
            selectedFiles = [];
            updateFileList();
            showMessage('All files removed', 'info');
        });
        
        // Force check upload button state initially
        uploadButton.disabled = selectedFiles.length === 0;
        
        // Make sure upload button is enabled when files are selected
        function updateUploadButtonState() {
            console.log('Updating button state, files count:', selectedFiles.length);
            uploadButton.disabled = selectedFiles.length === 0;
        }
        
        // Show status message
        function showMessage(message, type = 'info') {
            uploadMessages.textContent = message;
            uploadMessages.className = `alert alert-${type}`;
            uploadMessages.classList.remove('d-none');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                uploadMessages.classList.add('d-none');
            }, 5000);
        }

        // Handle form submission
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Upload form submitted');
            
            if (selectedFiles.length === 0) {
                showMessage('Please select at least one file to upload', 'warning');
                return;
            }
            
            // First check for folder name
            const folderName = document.getElementById('newFolderName').value.trim();
            
            if (!folderName) {
                showMessage('Please enter a folder name', 'warning');
                return;
            }
            
            // Disable upload button and show progress
            uploadButton.disabled = true;
            uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
            
            // Create FormData for file upload
            const formData = new FormData(uploadForm);
            selectedFiles.forEach(file => {
                formData.append('files[]', file);
            });
            
            // Show progress indicators
            overallProgressContainer.classList.remove('d-none');
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                const progressDiv = item.querySelector('.file-progress');
                if (progressDiv) progressDiv.classList.remove('d-none');
            });
            
            // Send the request
            fetch(uploadForm.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    selectedFiles = [];
                    updateFileList();
                    
                    // Reload the page after successful upload
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    throw new Error(data.message || 'Upload failed');
                }
            })
            .catch(error => {
                showMessage(`Error: ${error.message}`, 'danger');
                console.error('Upload error:', error);
            })
            .finally(() => {
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'Upload Files';
                overallProgressContainer.classList.add('d-none');
            });
        });
    }

    // Initialize document preview functionality
    const previewModal = document.getElementById('documentPreviewModal');
    const modalTitle = document.getElementById('documentPreviewModalLabel');
    const previewImage = document.getElementById('previewImage');
    const previewPdf = document.getElementById('previewPdf');

    // Handle file previews for existing files in the records list
    document.querySelectorAll('.file-item').forEach(item => {
        item.addEventListener('click', function() {
            const fileName = this.querySelector('.file-name').textContent;
            modalTitle.textContent = fileName;
            
            // Show the appropriate preview based on file type
            if (fileName.toLowerCase().endsWith('.pdf')) {
                previewPdf.classList.remove('d-none');
                previewPdf.src = `/static/uploads/${fileName}`;
                previewImage.classList.add('d-none');
            } else if (/\.(jpg|jpeg|png|gif)$/i.test(fileName)) {
                previewImage.classList.remove('d-none');
                previewImage.src = `/static/uploads/${fileName}`;
                previewPdf.classList.add('d-none');
            } else {
                previewPdf.classList.add('d-none');
                previewImage.classList.add('d-none');
                alert('This file type cannot be previewed directly.');
            }
            
            const modal = new bootstrap.Modal(previewModal);
            modal.show();
        });
    });
});
</script>
{% endblock %}
