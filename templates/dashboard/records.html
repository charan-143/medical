{% extends "base.html" %}

{% block title %}Medical Records - Medical Dashboard{% endblock %}

{% block styles %}
{{ super() }}
<style>
/* Grid layout for files and folders */
.folder-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
    margin: -1rem;  /* Compensate for container padding */
    width: 100%;    /* Ensure full width */
}

/* Folder and file items */
.folder-link, .file-item-wrapper {
    min-width: 0;   /* Allow items to shrink */
    height: 100%;   /* Maintain consistent height */
    position: relative;
}

/* Container styles */
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-body {
    padding: 1.5rem;
}

/* Common item styles */
.file-item, .folder-item {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1.25rem;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    height: 100%;
    position: relative;
    cursor: pointer;
}

/* Hover effects */
.file-item:hover, .folder-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-color: #4361ee;
    z-index: 1;
}

/* Icons */
.file-icon, .folder-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 50px;
    height: 50px;
}

.folder-icon {
    color: #ffc107;
}

.fa-file-image { color: #4361ee; }
.fa-file-pdf { color: #dc3545; }
.fa-file-word { color: #2c7be5; }
.fa-file-excel { color: #28a745; }

/* Names */
.file-name, .folder-name {
    font-weight: 500;
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    word-break: break-word;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    min-height: 2.5em;
}

/* File actions */
.file-actions {
    margin-top: auto;
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    width: 100%;
}

/* Section headers */
.text-muted.mb-3 {
    font-size: 1rem;
    font-weight: 600;
    margin-left: 1rem;
}

/* Fix folder links */
.folder-link a {
    display: block;
    height: 100%;
    text-decoration: none;
    color: inherit;
}

/* File and folder item states */
.file-item[data-file-path="None"], 
.file-item[data-file-path="#"], 
.file-unavailable {
    opacity: 0.6;
    background-color: transparent;
    box-shadow: none;
}

/* Ensure buttons are visible */
.btn {
    position: relative;
    z-index: 2;
}

/* Names */
.file-name, .folder-name {
    font-weight: 500;
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    word-break: break-word;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    min-height: 2.5em;  /* Ensure consistent height for names */
}

/* File actions */
.file-actions {
    margin-top: auto;
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    width: 100%;
}

#imagePreview img {
    max-height: 500px;
    border: 1px solid #dee2e6;
}

#pdfPreview iframe {
    border: 1px solid #dee2e6;
    background-color: #fff;
}

#previewPlaceholder {
    padding: 50px 0;
}

/* File metadata styling */
.file-details {
    padding: 10px 0;
}

.file-metadata {
    margin-top: 20px;
}

/* Download button styling */
#downloadButton {
    background-color: #4361ee;
    border-color: #4361ee;
    transition: all 0.3s ease;
}

#downloadButton:hover {
    background-color: #3651d4;
    border-color: #3651d4;
}

.drag-drop-area.highlight {
    border-color: #4361ee;
    background-color: #edf2ff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Responsive adjustments */
@media (max-width: 767.98px) {
    .modal-dialog {
        margin: 0.5rem;
    }
    
    .modal-body .row {
        flex-direction: column-reverse;
    }
    
    .document-preview {
        min-height: 200px;
        margin-top: 15px;
    }
    
    .folder-container {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        padding: 0.75rem;
    }
    
    .file-item, .folder-item {
        padding: 1rem;
    }
    
    .file-icon, .folder-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
    }
    
    #pdfPreview iframe {
        height: 300px;
    }
}

/* File preview modal */
#imagePreview img {
    max-height: 500px;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
}

#pdfPreview iframe {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    background-color: #fff;
    width: 100%;
    height: 600px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Medical Records</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="fas fa-upload me-2"></i> Upload Files
        </button>
    </div>
    
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.records') }}">Records Home</a></li>
            {% if current_folder %}
                <li class="breadcrumb-item active">{{ current_folder.name }}</li>
            {% endif %}
        </ol>
    </nav>
    
    <!-- Files and Folders Container -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">{{ current_folder.name if current_folder else 'All Records' }}</h5>
                </div>
                <div class="card-body">
                    {% if subfolders or documents %}
                        <!-- Folders Section -->
                        {% if subfolders %}
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">Folders</h6>
                            <div class="folder-container">
                                {% for folder in subfolders %}
                                <div class="folder-link">
                                    <a href="{{ url_for('dashboard.records', folder_id=folder.id) }}" class="text-decoration-none w-100">
                                        <div class="folder-item">
                                            <div class="folder-icon">
                                                <i class="fas fa-folder"></i>
                                            </div>
                                            <div class="folder-name">{{ folder.name }}</div>
                                        </div>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Files Section -->
                        {% if documents %}
                        <div>
                            <h6 class="text-muted mb-3">Files</h6>
                            <div class="folder-container">
                                {% for document in documents %}
                                {% set info = document.get_file_info() %}
                                <div class="file-item-wrapper">
                                    <div class="file-item" 
                                         data-file-path="{{ info.url_path }}"
                                         data-filename="{{ info.filename }}"
                                         data-file-type="{{ info.file_type }}"
                                         data-file-size="{{ info.file_size }}"
                                         data-upload-date="{{ info.upload_date }}"
                                         data-description="{{ info.description }}">
                                        <div class="file-icon">
                                            {% set file_type = info.file_type.lower() %}
                                            {% if file_type in ['jpg', 'jpeg', 'png', 'gif'] %}
                                                <i class="fas fa-file-image"></i>
                                            {% elif file_type == 'pdf' %}
                                                <i class="fas fa-file-pdf"></i>
                                            {% elif file_type in ['doc', 'docx'] %}
                                                <i class="fas fa-file-word"></i>
                                            {% elif file_type in ['xls', 'xlsx'] %}
                                                <i class="fas fa-file-excel"></i>
                                            {% else %}
                                                <i class="fas fa-file"></i>
                                            {% endif %}
                                        </div>
                                        <div class="file-name">{{ info.filename }}</div>
                                        <div class="file-actions">
                                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="viewFile(this)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="{{ info.url_path }}" download="{{ info.filename }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <!-- Empty State -->
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-folder-open fa-4x text-muted"></i>
                            </div>
                            <h5>This folder is empty</h5>
                            <p class="text-muted">Upload files or create folders to organize your medical records.</p>
                            <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fas fa-upload me-2"></i> Upload Files
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Upload Files</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" action="{{ url_for('dashboard.upload_json') }}" method="POST" enctype="multipart/form-data">
                        {{ csrf_token() }}
                        <input type="hidden" id="uploadFolderId" name="folder_id" value="{{ current_folder.id if current_folder else '' }}">
                        
                        <div class="mb-3">
                            <label for="createFolder" class="form-label">Create New Folder (Optional)</label>
                            <input type="text" class="form-control" id="createFolder" placeholder="Enter folder name">
                            <div class="form-text">Leave empty to upload files to the current folder.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="fileUpload" class="form-label">Select Files</label>
                            <div class="drag-drop-area p-4 border rounded text-center" id="dragDropArea">
                                <i class="fas fa-cloud-upload-alt fa-2x mb-3 text-primary"></i>
                                <p>Drag & drop files here, or click to select files</p>
                                <input type="file" id="fileUpload" multiple class="d-none">
                                <button type="button" id="browseButton" class="btn btn-outline-primary">Browse Files</button>
                            </div>
                        </div>
                        
                        <div id="fileList" class="mb-3"></div>
                        
                        <div id="overallProgressContainer" class="mb-3 d-none">
                            <label class="form-label">Upload Progress</label>
                            <div class="progress">
                                <div id="overallProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="uploadButton" class="btn btn-primary">Upload Files</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Document Preview Modal -->
    <div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentPreviewModalLabel">Document Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="document-preview bg-light rounded p-3 d-flex align-items-center justify-content-center">
                                <!-- Image Preview -->
                                <div id="imagePreview" class="text-center d-none">
                                    <img id="previewImage" src="" alt="File Preview" class="img-fluid">
                                </div>
                                
                                <!-- PDF Preview -->
                                <div id="pdfPreview" class="w-100 d-none">
                                    <iframe id="previewPdf" src="" width="100%" height="600" frameborder="0"></iframe>
                                </div>
                                
                                <!-- Placeholder for other file types -->
                                <div id="previewPlaceholder" class="text-center d-none">
                                    <i class="fas fa-file fa-5x text-muted mb-3"></i>
                                    <h5>Preview not available</h5>
                                    <p>This file type cannot be previewed. Please download the file to view it.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="file-metadata">
                                <h5 class="mb-3">File Information</h5>
                                <div class="file-details">
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">File Name:</div>
                                        <div class="col-8" id="fileName">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Type:</div>
                                        <div class="col-8" id="fileType">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Size:</div>
                                        <div class="col-8" id="fileSize">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">Uploaded:</div>
                                        <div class="col-8" id="uploadDate">-</div>
                                    </div>
                                    <div class="row mb-2" id="descriptionRow">
                                        <div class="col-4 text-muted">Description:</div>
                                        <div class="col-8" id="fileDescription">-</div>
                                    </div>
                                </div>
                                <a href="#" id="downloadButton" download class="btn btn-primary w-100 mt-3">
                                    <i class="fas fa-download me-2"></i> Download File
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // File upload handling
    const dragDropArea = document.getElementById('dragDropArea');
    const fileUpload = document.getElementById('fileUpload');
    const browseButton = document.getElementById('browseButton');
    const fileList = document.getElementById('fileList');
    const uploadForm = document.getElementById('uploadForm');
    const uploadButton = document.getElementById('uploadButton');
    const overallProgressContainer = document.getElementById('overallProgressContainer');
    const overallProgress = document.getElementById('overallProgress');
    const createFolderInput = document.getElementById('createFolder');
    
    // Preview modal elements
    const previewModal = document.getElementById('documentPreviewModal');
    const modalTitle = document.getElementById('documentPreviewModalLabel');
    const imagePreview = document.getElementById('imagePreview');
    const pdfPreview = document.getElementById('pdfPreview');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const previewImage = document.getElementById('previewImage');
    const previewPdf = document.getElementById('previewPdf');
    const fileName = document.getElementById('fileName');
    const fileType = document.getElementById('fileType');
    const fileSize = document.getElementById('fileSize');
    const uploadDate = document.getElementById('uploadDate');
    const fileDescription = document.getElementById('fileDescription');
    const descriptionRow = document.getElementById('descriptionRow');
    const downloadButton = document.getElementById('downloadButton');
    
    // Store selected files
    let selectedFiles = [];
    let blobUrls = {};
    
    // Helper function to check if a string appears to be a template literal
    function isTemplateLiteral(str) {
        return typeof str === 'string' && (
            str.includes('${') || 
            str.includes('}}') || 
            str === '' || 
            str === 'None' || 
            str === '#'
        );
    }
    
    // Helper function to format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Set the file type icon based on file extension
    function setFileTypeIcon(fileType) {
        let iconClass = 'fa-file';
        
        if (['jpg', 'jpeg', 'png', 'gif'].includes(fileType.toLowerCase())) {
            iconClass = 'fa-file-image';
        } else if (['pdf'].includes(fileType.toLowerCase())) {
            iconClass = 'fa-file-pdf';
        } else if (['doc', 'docx'].includes(fileType.toLowerCase())) {
            iconClass = 'fa-file-word';
        } else if (['xls', 'xlsx'].includes(fileType.toLowerCase())) {
            iconClass = 'fa-file-excel';
        }
        
        // Set the icon in the modal
        const iconElement = document.createElement('i');
        iconElement.className = `fas ${iconClass} fa-2x mb-3`;
        
        // Clear any existing icon and append the new one
        const iconContainer = document.querySelector('.file-icon-preview');
        if (iconContainer) {
            iconContainer.innerHTML = '';
            iconContainer.appendChild(iconElement);
        }
    }
    
    // Helper function to show messages
    // Helper function to show messages
    function showMessage(message, type = 'info') {
        // Log message to console
        console.log(`${type.toUpperCase()}: ${message}`);
        
        // Add icons based on message type
        const icon = {
            success: '<i class="fas fa-check-circle me-2"></i>',
            danger: '<i class="fas fa-exclamation-circle me-2"></i>',
            warning: '<i class="fas fa-exclamation-triangle me-2"></i>',
            info: '<i class="fas fa-info-circle me-2"></i>'
        }[type] || '';
        
        // Create an alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.style.maxWidth = '400px';
        alertDiv.innerHTML = `
            ${icon}${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add to document body
        document.body.appendChild(alertDiv);
        
        // Remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    // Update the file list display
    function updateFileList() {
        fileList.innerHTML = '';
        
        if (selectedFiles.length === 0) {
            fileList.innerHTML = '<p class="text-muted">No files selected</p>';
            return;
        }
        
        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item mb-2 p-2 border rounded';
            
            const fileIcon = document.createElement('i');
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                fileIcon.className = 'fas fa-file-image me-2 text-primary';
            } else if (fileExt === 'pdf') {
                fileIcon.className = 'fas fa-file-pdf me-2 text-danger';
            } else if (['doc', 'docx'].includes(fileExt)) {
                fileIcon.className = 'fas fa-file-word me-2 text-info';
            } else if (['xls', 'xlsx'].includes(fileExt)) {
                fileIcon.className = 'fas fa-file-excel me-2 text-success';
            } else {
                fileIcon.className = 'fas fa-file me-2 text-secondary';
            }
            
            const fileName = document.createElement('span');
            fileName.textContent = file.name;
            
            const fileSize = document.createElement('span');
            fileSize.className = 'ms-auto badge bg-light text-dark';
            fileSize.textContent = formatFileSize(file.size);
            
            const removeButton = document.createElement('button');
            removeButton.className = 'btn btn-sm btn-outline-danger ms-2';
            removeButton.innerHTML = '<i class="fas fa-times"></i>';
            removeButton.onclick = function() {
                selectedFiles.splice(index, 1);
                updateFileList();
            };
            
            const fileProgress = document.createElement('div');
            fileProgress.className = 'progress mt-2 d-none file-progress';
            fileProgress.innerHTML = `
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            `;
            
            fileItem.appendChild(fileIcon);
            fileItem.appendChild(fileName);
            fileItem.appendChild(fileSize);
            fileItem.appendChild(removeButton);
            fileItem.appendChild(fileProgress);
            
            fileList.appendChild(fileItem);
        });
    }
    
    // Browse button click handler
    browseButton.addEventListener('click', function() {
        fileUpload.click();
    });
    
    // File input change handler
    fileUpload.addEventListener('change', function() {
        if (this.files.length > 0) {
            Array.from(this.files).forEach(file => {
                selectedFiles.push(file);
            });
            updateFileList();
        }
    });
    
    // Drag and drop handlers
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, function() {
            this.classList.add('highlight');
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dragDropArea.addEventListener(eventName, function() {
            this.classList.remove('highlight');
        }, false);
    });
    
    dragDropArea.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            Array.from(files).forEach(file => {
                selectedFiles.push(file);
            });
            updateFileList();
        }
    }, false);
    
    // Upload button click handler
    uploadButton.addEventListener('click', function() {
        if (selectedFiles.length === 0) {
            showMessage('Please select files to upload', 'warning');
            return;
        }
        
        // Check if we're creating a new folder
        const folderName = createFolderInput.value.trim();
        
        if (folderName) {
            // Create folder and then upload files to it
            createFolderAndUpload(folderName);
        } else {
            // Upload directly to current folder
            uploadFiles();
        }
    });
    
    // Function to create folder and then upload files
    // Function to create folder and then upload files
    function createFolderAndUpload(folderName) {
        // Validate folder name
        // Validate folder name
        if (!folderName || folderName.length < 1 || folderName.length > 100) {
            showMessage('Folder name must be between 1 and 100 characters', 'warning');
            return;
        }
        
        // Verify CSRF token exists
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        if (!csrfToken) {
            showMessage('CSRF token not found. Please refresh the page.', 'danger');
            return;
        }
        // File type validation
        const allowedTypes = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'doc', 'docx', 'xls', 'xlsx'];
        const invalidFiles = selectedFiles.filter(file => {
            const ext = file.name.split('.').pop().toLowerCase();
            return !allowedTypes.includes(ext);
        });

        if (invalidFiles.length > 0) {
            showMessage(`Invalid file type(s): ${invalidFiles.map(f => f.name).join(', ')}. Allowed types: ${allowedTypes.join(', ')}`, 'warning');
            return;
        }
        
        // Size validation
        const maxSize = 10 * 1024 * 1024; // 10MB
        const oversizedFiles = selectedFiles.filter(file => file.size > maxSize);

        if (oversizedFiles.length > 0) {
            showMessage(`File(s) too large: ${oversizedFiles.map(f => f.name).join(', ')}. Maximum size: 10MB`, 'warning');
            return;
        }
        
        // Disable upload button and show progress
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating folder...';
        
        // Get the parent folder ID
        const currentFolderId = document.getElementById('uploadFolderId').value.trim();
        
        // Create form data for folder creation
        const folderFormData = new FormData();
        folderFormData.append('folder_name', folderName);
        folderFormData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
        if (currentFolderId) {
            folderFormData.append('parent_id', currentFolderId);
        }
        
        console.log('Creating folder with data:', {
            folderName,
            parentId: currentFolderId
        });

        // Create the folder
        fetch("{{ url_for('dashboard.create_folder_json') }}", {
            method: 'POST',
            body: folderFormData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(folderData => {
            if (!folderData.success) {
                throw new Error(folderData.message || 'Failed to create folder');
            }
            console.log('Folder created successfully:', folderData);

            // Folder created successfully, now upload files
            console.log('Folder created with ID:', folderData.folder_id);
            showMessage(`Folder "${folderName}" created successfully. Uploading files...`, 'info');
            
            // Update button text
            uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading files...';
            
            // Show progress indicators
            overallProgressContainer.classList.remove('d-none');
            
            // Setup progress tracking
            let uploadedFiles = 0;
            const totalFiles = selectedFiles.length;
            
            // Update progress bar
            const updateProgress = () => {
                const progress = Math.round((uploadedFiles / totalFiles) * 100);
                overallProgress.style.width = `${progress}%`;
                overallProgress.textContent = `${progress}%`;
                overallProgress.setAttribute('aria-valuenow', progress);
            };
            
            // Initialize progress
            updateProgress();
            
            // Create FormData for file upload
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('csrf_token', csrfToken);
            formData.append('folder_id', folderData.folder_id);
            selectedFiles.forEach(file => {
                formData.append('files[]', file);  // Change from 'file' to 'files[]' to match server expectation
            });
            
            // Debug log formData contents
            console.log('FormData contents:');
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + (pair[0] === 'files[]' ? pair[1].name : pair[1]));
            }
            console.log('Uploading files to folder:', folderData.folder_id);
            
            // Upload files to new folder
            return fetch(uploadForm.action, {
                method: 'POST',
                body: formData
            });
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Upload response:', data);
            if (data.success) {
                // Update progress to 100%
                const totalFiles = selectedFiles.length;
                overallProgress.style.width = '100%';
                overallProgress.textContent = '100%';
                overallProgress.setAttribute('aria-valuenow', 100);
                
                showMessage(`Files uploaded successfully to folder "${folderName}"`, 'success');
                selectedFiles = [];
                updateFileList();
                
                // Reload the page after successful upload
                setTimeout(() => window.location.reload(), 1500);
            } else {
                // More specific error handling for upload failures
                if (data.message && data.message.includes('duplicate')) {
                    throw new Error('A file with the same content already exists');
                } else if (data.message && data.message.includes('permission')) {
                    throw new Error('You do not have permission to upload to this folder');
                } else {
                    throw new Error(data.message || 'Upload failed');
                }
            }
        })
        .catch(error => {
            showMessage(`Error: ${error.message}`, 'danger');
            console.error('Upload error:', error);
            console.error('Error details:', error.stack);
            
            // If the error is related to folder creation, inform the user
            if (error.message.includes('Failed to create folder')) {
                showMessage('Could not create the folder. Please try a different folder name or check permissions.', 'warning');
            }
        })
        .finally(() => {
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Upload Files';
            overallProgressContainer.classList.add('d-none');
            // Cleanup: Revoke all blob URLs after upload completes
            try {
                Object.values(blobUrls).forEach(url => {
                    if (url) URL.revokeObjectURL(url);
                });
                blobUrls = {};
            } catch (e) {
                console.error('Error cleaning up blob URLs:', e);
            }
        });
    }
    
    // Function to upload files directly to current folder
    function uploadFiles() {
        // Verify CSRF token exists
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        if (!csrfToken) {
            showMessage('CSRF token not found. Please refresh the page.', 'danger');
            return;
        }
        
        // Disable upload button and show progress
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
        
        // File type validation
        const allowedTypes = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'doc', 'docx', 'xls', 'xlsx'];
        const invalidFiles = selectedFiles.filter(file => {
            const ext = file.name.split('.').pop().toLowerCase();
            return !allowedTypes.includes(ext);
        });

        if (invalidFiles.length > 0) {
            showMessage(`Invalid file type(s): ${invalidFiles.map(f => f.name).join(', ')}. Allowed types: ${allowedTypes.join(', ')}`, 'warning');
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Upload Files';
            return;
        }
        
        // Size validation
        const maxSize = 10 * 1024 * 1024; // 10MB
        const oversizedFiles = selectedFiles.filter(file => file.size > maxSize);

        if (oversizedFiles.length > 0) {
            showMessage(`File(s) too large: ${oversizedFiles.map(f => f.name).join(', ')}. Maximum size: 10MB`, 'warning');
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Upload Files';
            return;
        }
        
        // Create FormData for file upload more explicitly
        // Create FormData for file upload more explicitly
        const formData = new FormData();
        
        // Add the CSRF token from the form
        formData.append('csrf_token', csrfToken);
        
        // Add the folder ID if it exists
        const folderId = document.getElementById('uploadFolderId').value.trim();
        if (folderId) formData.append('folder_id', folderId);
        
        // Ad        // Add each file
        selectedFiles.forEach(file => {
            formData.append('files[]', file);  // Change from 'file' to 'files[]' to match server expectation
        });
        
        // Debug log formData contents
        console.log('FormData contents:');
        for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + (pair[0] === 'files[]' ? pair[1].name : pair[1]));
        }
        
        // Setup progress tracking
        let uploadedFiles = 0;
        const totalFiles = selectedFiles.length;
        
        // Update progress bar
        const updateProgress = () => {
            const progress = Math.round((uploadedFiles / totalFiles) * 100);
            overallProgress.style.width = `${progress}%`;
            overallProgress.textContent = `${progress}%`;
            overallProgress.setAttribute('aria-valuenow', progress);
        };
        
        // Initialize progress
        updateProgress();
        
        // Show progress indicators
        overallProgressContainer.classList.remove('d-none');
        const fileItems = document.querySelectorAll('.file-item');
        fileItems.forEach(item => {
            const progressDiv = item.querySelector('.file-progress');
            if (progressDiv) progressDiv.classList.remove('d-none');
        });
        
        console.log('Sending file upload request to:', uploadForm.action);
        
        // Send the upload request
        fetch(uploadForm.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Upload response received:', data);
            console.log('Upload response:', data);
            if (data.success) {
                showMessage('Files uploaded successfully', 'success');
                selectedFiles = [];
                updateFileList();
                
                // Reload the page after successful upload
                setTimeout(() => window.location.reload(), 1500);
            } else {
                // More specific error handling for different failure scenarios
                if (data.message && data.message.includes('duplicate')) {
                    throw new Error('A file with the same content already exists');
                } else if (data.message && data.message.includes('permission')) {
                    throw new Error('You do not have permission to upload to this folder');
                } else if (data.message && data.message.includes('large')) {
                    throw new Error('File size exceeds the maximum allowed limit');
                } else if (data.message && data.message.includes('type')) {
                    throw new Error('File type not allowed');
                } else {
                    throw new Error(data.message || 'Upload failed');
                }
            }
        })
        .catch(error => {
            showMessage(`Error: ${error.message}`, 'danger');
            console.error('Upload error:', error);
            console.error('Error details:', error.stack);
            
            // Enable upload button
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Upload Files';
        })
        .finally(() => {
            uploadButton.disabled = false;
            overallProgressContainer.classList.add('d-none');
            
            // Cleanup: Revoke all blob URLs
            try {
                Object.values(blobUrls).forEach(url => {
                    if (url) URL.revokeObjectURL(url);
                });
                blobUrls = {};
            } catch (e) {
                console.error('Error cleaning up blob URLs:', e);
            }
            blobUrls = {};
        });
    }
    
    // Initialize file preview functionality
    document.querySelectorAll('.file-item').forEach(fileItem => {
        fileItem.addEventListener('click', function(e) {
            // Don't trigger for click on action buttons
            if (e.target.closest('.file-actions')) {
                return;
            }
            
            // Get file metadata from data attributes
            // Get file metadata from data attributes
            const fileData = this.dataset;
            let filePath = fileData.filePath;
            const fileTypeValue = fileData.fileType;
            
            // Safety check to prevent ${blobUrl} being sent as a literal
            if (isTemplateLiteral(filePath)) {
                console.error("Template literal detected in filePath:", filePath);
                filePath = "#"; // Reset to prevent 404s
            }
            // Reset all preview containers
            imagePreview.classList.add('d-none');
            pdfPreview.classList.add('d-none');
            previewPlaceholder.classList.add('d-none');
            
            // Set modal title and metadata
            modalTitle.textContent = fileData.filename;
            fileName.textContent = fileData.filename;
            fileType.textContent = fileTypeValue.toUpperCase();
            fileSize.textContent = formatFileSize(parseInt(fileData.fileSize));
            uploadDate.textContent = fileData.uploadDate;
            
            // Set download button
            downloadButton.href = filePath;
            downloadButton.download = fileData.filename;
            
            // Set file type icon
            setFileTypeIcon(fileTypeValue);
            
            // Set description if available
            if (fileData.description && fileData.description.trim()) {
                fileDescription.textContent = fileData.description;
                descriptionRow.classList.remove('d-none');
            } else {
                fileDescription.textContent = '-';
                descriptionRow.classList.add('d-none');
            }
            
            // Set download button - ensure filePath is properly set
            if (filePath && !filePath.includes('${')) {
                downloadButton.href = filePath;
                downloadButton.download = fileData.filename;
            } else {
                console.error("Invalid file path detected:", filePath);
                downloadButton.href = "#";
                downloadButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert("Download link not available. Please try refreshing the page.");
                });
            }
            
            // Show the appropriate preview based on file type
            if (fileTypeValue.toLowerCase() === 'pdf') {
                pdfPreview.classList.remove('d-none');
                // Ensure the filePath is a valid URL (not a template literal)
                previewPdf.src = filePath;
            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileTypeValue.toLowerCase())) {
                imagePreview.classList.remove('d-none');
                // Ensure the filePath is a valid URL (not a template literal)
                previewImage.src = filePath;
                previewImage.alt = fileData.filename;
            } else {
                // For other file types, show placeholder
                previewPlaceholder.classList.remove('d-none');
            }
            
            // Show the modal
            const modal = new bootstrap.Modal(previewModal);
            modal.show();
        });
    });
});
</script>
{% endblock %}
