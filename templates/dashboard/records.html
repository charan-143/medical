{% extends "base.html" %} {% block title %}Medical Records - Medical Dashboard{%
endblock %} {% block styles %} {{ super() }}
<style>
	/* Tab styling for subfolder navigation */
	.folder-tabs .nav-link {
		color: #495057;
		font-weight: 500;
		border: none;
		border-bottom: 2px solid transparent;
		padding: 0.75rem 1rem;
		transition: all 0.2s ease;
	}

	.folder-tabs .nav-link.active {
		color: #4361ee;
		background-color: transparent;
		border-bottom: 2px solid #4361ee;
	}

	.folder-tabs .nav-link:hover:not(.active) {
		border-bottom: 2px solid #dee2e6;
	}

	/* AI content section */
	.ai-content {
		background-color: #f8f9fa;
		border-radius: 0.5rem;
		padding: 1.5rem;
		border: 1px solid #dee2e6;
	}

	.ai-content h3 {
		color: #4361ee;
		margin-bottom: 1rem;
		font-size: 1.25rem;
	}

	.ai-content .text-section {
		margin-bottom: 1.5rem;
	}

	/* Markdown content styling */
	.markdown-content {
		font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
		line-height: 1.6;
		color: #212529;
	}

	.markdown-content h1, 
	.markdown-content h2, 
	.markdown-content h3, 
	.markdown-content h4, 
	.markdown-content h5, 
	.markdown-content h6 {
		margin-top: 1.5rem;
		margin-bottom: 1rem;
		font-weight: 600;
		line-height: 1.25;
		color: #2d3748;
	}

	.markdown-content h1 { font-size: 2rem; }
	.markdown-content h2 { font-size: 1.5rem; }
	.markdown-content h3 { font-size: 1.25rem; }
	.markdown-content h4 { font-size: 1.1rem; }
	.markdown-content h5 { font-size: 1rem; }
	.markdown-content h6 { font-size: 0.875rem; }

	.markdown-content p {
		margin-bottom: 1rem;
	}

	.markdown-content ul,
	.markdown-content ol {
		margin-bottom: 1rem;
		padding-left: 2rem;
	}

	.markdown-content li {
		margin-bottom: 0.5rem;
	}

	.markdown-content code {
		padding: 0.2em 0.4em;
		background-color: #f3f4f6;
		border-radius: 0.25rem;
		font-family: SFMono-Regular, Menlo, Monaco, Consolas, monospace;
		font-size: 0.875em;
	}

	.markdown-content pre {
		padding: 1rem;
		background-color: #f3f4f6;
		border-radius: 0.5rem;
		overflow-x: auto;
		margin-bottom: 1rem;
	}

	.markdown-content pre code {
		padding: 0;
		background-color: transparent;
	}

	.markdown-content blockquote {
		padding: 0.5rem 1rem;
		margin-bottom: 1rem;
		border-left: 4px solid #4361ee;
		background-color: #e9ecef;
		color: #495057;
	}

	.markdown-content table {
		width: 100%;
		margin-bottom: 1rem;
		border-collapse: collapse;
	}

	.markdown-content th,
	.markdown-content td {
		padding: 0.75rem;
		border: 1px solid #dee2e6;
	}

	.markdown-content th {
		background-color: #f8f9fa;
		font-weight: 600;
	}

	.markdown-content a {
		color: #4361ee;
		text-decoration: none;
	}

	.markdown-content a:hover {
		text-decoration: underline;
	}

	.markdown-content hr {
		margin: 2rem 0;
		border: 0;
		border-top: 1px solid #dee2e6;
	}

	/* Error message styling with markdown */
	#summaryError .alert {
		margin-bottom: 0;
	}

	#errorMessage.markdown-content h2 {
		color: #dc3545;
		margin-top: 0;
		font-size: 1.25rem;
	}

	/* Grid layout for files and folders */
	.folder-container {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
		gap: 1.5rem;
		padding: 1rem;
		margin: -1rem; /* Compensate for container padding */
		width: 100%; /* Ensure full width */
	}

	/* Folder and file items */
	.folder-link,
	.file-item-wrapper {
		min-width: 0; /* Allow items to shrink */
		height: 100%; /* Maintain consistent height */
		position: relative;
	}

	/* Container styles */
	.card {
		box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
	}

	.card-body {
		padding: 1.5rem;
	}

	/* Common item styles */
	.file-item,
	.folder-item {
		background-color: #ffffff;
		border: 1px solid #dee2e6;
		border-radius: 0.5rem;
		padding: 1.25rem;
		transition: all 0.2s ease;
		display: flex;
		flex-direction: column;
		align-items: center;
		text-align: center;
		height: 100%;
		position: relative;
		cursor: pointer;
	}

	/* Hover effects */
	.file-item:hover,
	.folder-item:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		border-color: #4361ee;
		z-index: 1;
	}

	/* Icons */
	.file-icon,
	.folder-icon {
		font-size: 2rem;
		margin-bottom: 1rem;
		display: flex;
		justify-content: center;
		align-items: center;
		width: 50px;
		height: 50px;
	}

	.folder-icon {
		color: #ffc107;
	}

	.fa-file-image {
		color: #4361ee;
	}
	.fa-file-pdf {
		color: #dc3545;
	}
	.fa-file-word {
		color: #2c7be5;
	}
	.fa-file-excel {
		color: #28a745;
	}

	/* Names */
	.file-name,
	.folder-name {
		font-weight: 500;
		font-size: 0.9rem;
		margin-bottom: 0.75rem;
		word-break: break-word;
		max-width: 100%;
		overflow: hidden;
		text-overflow: ellipsis;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		min-height: 2.5em;
	}

	/* File actions */
	.file-actions {
		margin-top: auto;
		display: flex;
		gap: 0.5rem;
		justify-content: center;
		width: 100%;
	}

	/* Section headers */
	.text-muted.mb-3 {
		font-size: 1rem;
		font-weight: 600;
		margin-left: 1rem;
	}

	/* Fix folder links */
	.folder-link a {
		display: block;
		height: 100%;
		text-decoration: none;
		color: inherit;
	}

	/* File and folder item states */
	.file-item[data-file-path="None"],
	.file-item[data-file-path="#"],
	.file-unavailable {
		opacity: 0.6;
		background-color: transparent;
		box-shadow: none;
	}

	/* Ensure buttons are visible */
	.btn {
		position: relative;
		z-index: 2;
	}

	/* Names */
	.file-name,
	.folder-name {
		font-weight: 500;
		font-size: 0.9rem;
		margin-bottom: 0.75rem;
		word-break: break-word;
		max-width: 100%;
		overflow: hidden;
		text-overflow: ellipsis;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		min-height: 2.5em; /* Ensure consistent height for names */
	}

	/* File actions */
	.file-actions {
		margin-top: auto;
		display: flex;
		gap: 0.5rem;
		justify-content: center;
		width: 100%;
	}

	#imagePreview img {
		max-height: 500px;
		border: 1px solid #dee2e6;
	}

	#pdfPreview iframe {
		border: 1px solid #dee2e6;
		background-color: #fff;
	}

	#previewPlaceholder {
		padding: 50px 0;
	}

	/* File metadata styling */
	.file-details {
		padding: 10px 0;
	}

	.file-metadata {
		margin-top: 20px;
	}

	/* Download button styling */
	#downloadButton {
		background-color: #4361ee;
		border-color: #4361ee;
		transition: all 0.3s ease;
	}

	#downloadButton:hover {
		background-color: #3651d4;
		border-color: #3651d4;
	}

	/* File type icon styling in preview modal */
	.file-icon-preview {
		margin-bottom: 1.5rem;
	}

	.file-icon-preview .fa-file-image {
		color: #4361ee;
	}

	.file-icon-preview .fa-file-pdf {
		color: #dc3545;
	}

	.file-icon-preview .fa-file-word {
		color: #2c7be5;
	}

	.file-icon-preview .fa-file-excel {
		color: #28a745;
	}

	.drag-drop-area.highlight {
		border-color: #4361ee;
		background-color: #edf2ff;
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
	}

	/* Responsive adjustments */
	@media (max-width: 767.98px) {
		.modal-dialog {
			margin: 0.5rem;
		}

		.modal-body .row {
			flex-direction: column-reverse;
		}

		.document-preview {
			min-height: 200px;
			margin-top: 15px;
		}

		.folder-container {
			grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
			gap: 1rem;
			padding: 0.75rem;
		}

		.file-item,
		.folder-item {
			padding: 1rem;
		}

		.file-icon,
		.folder-icon {
			font-size: 1.5rem;
			width: 40px;
			height: 40px;
		}

		#pdfPreview iframe {
			height: 300px;
		}
	}

	/* File preview modal */
	#imagePreview img {
		max-height: 500px;
		border: 1px solid #dee2e6;
		border-radius: 0.5rem;
	}

	#pdfPreview iframe {
		border: 1px solid #dee2e6;
		border-radius: 0.5rem;
		background-color: #fff;
		width: 100%;
		height: 600px;
	}
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h2>Medical Records</h2>
		<button
			class="btn btn-primary"
			data-bs-toggle="modal"
			data-bs-target="#uploadModal"
		>
			<i class="fas fa-upload me-2"></i> Upload Files
		</button>
	</div>

	<!-- Breadcrumb Navigation -->
	<nav aria-label="breadcrumb" class="mb-4">
		<ol class="breadcrumb">
			<li class="breadcrumb-item">
				<a href="{{ url_for('dashboard.records') }}">Records Home</a>
			</li>
			{% if current_folder %}
			<li class="breadcrumb-item active">{{ current_folder.name }}</li>
			{% endif %}
		</ol>
	</nav>

	<!-- Files and Folders Container -->
	<div class="row">
		<div class="col-12">
			<div class="card shadow-sm mb-4">
				<div class="card-header bg-white py-3">
					<h5 class="mb-0">
						{{ current_folder.name if current_folder else 'All Records' }}
					</h5>
					{% if current_folder %}
					<!-- Tabs for the subfolder view -->
					<ul class="nav nav-tabs folder-tabs mt-3" id="folderTabs" role="tablist">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="files-tab" data-bs-toggle="tab" data-bs-target="#files-tab-pane" type="button" role="tab" aria-controls="files-tab-pane" aria-selected="true">
								<i class="fas fa-file me-2"></i>Files
							</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="ai-text-tab" data-bs-toggle="tab" data-bs-target="#ai-text-tab-pane" type="button" role="tab" aria-controls="ai-text-tab-pane" aria-selected="false">
								<i class="fas fa-robot me-2"></i>AI Generated Text
							</button>
						</li>
					</ul>
					{% endif %}
				</div>
				<div class="card-body">
					{% if current_folder %}
					<!-- Tab content for subfolder view -->
					<div class="tab-content" id="folderTabsContent">
						<!-- Files tab -->
						<div class="tab-pane fade show active" id="files-tab-pane" role="tabpanel" aria-labelledby="files-tab" tabindex="0">
							{% if subfolders or documents %}
					<!-- Folders Section -->
					{% if subfolders %}
					<div class="mb-4">
						<h6 class="text-muted mb-3">Folders</h6>
						<div class="folder-container">
							{% for folder in subfolders %}
							<div class="folder-link">
								<a
									href="{{ url_for('dashboard.records', folder_id=folder.id) }}"
									class="text-decoration-none w-100"
								>
									<div class="folder-item">
										<div class="folder-icon">
											<i class="fas fa-folder"></i>
										</div>
										<div class="folder-name">{{ folder.name }}</div>
									</div>
								</a>
							</div>
							{% endfor %}
						</div>
					</div>
					{% endif %}

					<!-- Files Section -->
					{% if documents %}
					<div>
						<h6 class="text-muted mb-3">Files</h6>
						<div class="folder-container">
							{% for document in documents %} {% set info =
							document.get_file_info() %}
							<div class="file-item-wrapper">
								<div
									class="file-item"
									data-file-path="{{ info.url_path }}"
									data-filename="{{ info.filename }}"
									data-file-type="{{ info.file_type }}"
									data-file-size="{{ info.file_size }}"
									data-upload-date="{{ info.upload_date }}"
									data-description="{{ info.description }}"
									data-document-id="{{ document.id }}"
								>
									<div class="file-icon">
										{% set file_type = info.file_type.lower() %} {% if file_type
										in ['jpg', 'jpeg', 'png', 'gif'] %}
										<i class="fas fa-file-image"></i>
										{% elif file_type == 'pdf' %}
										<i class="fas fa-file-pdf"></i>
										{% elif file_type in ['doc', 'docx'] %}
										<i class="fas fa-file-word"></i>
										{% elif file_type in ['xls', 'xlsx'] %}
										<i class="fas fa-file-excel"></i>
										{% else %}
										<i class="fas fa-file"></i>
										{% endif %}
									</div>
									<div class="file-name">{{ info.filename }}</div>
									<div class="file-actions">
										<button
											class="btn btn-sm btn-outline-secondary me-1 view-file-btn"
											type="button"
										>
											<i class="fas fa-eye"></i>
										</button>
										<a
											href="{{ info.url_path }}"
											download="{{ info.filename }}"
											class="btn btn-sm btn-outline-primary"
										>
											<i class="fas fa-download"></i>
										</a>
									</div>
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
					{% endif %} {% else %}
					<!-- Empty State -->
					<div class="text-center py-5">
						<div class="mb-3">
							<i class="fas fa-folder-open fa-4x text-muted"></i>
						</div>
						<h5>This folder is empty</h5>
						<p class="text-muted">
							Upload files or create folders to organize your medical records.
						</p>
						<button
							class="btn btn-primary mt-3"
							data-bs-toggle="modal"
							data-bs-target="#uploadModal"
						>
							<i class="fas fa-upload me-2"></i> Upload Files
						</button>
					</div>
							{% endif %}
						</div>
						
						<!-- AI Generated Text tab -->
						<div class="tab-pane fade" id="ai-text-tab-pane" role="tabpanel" aria-labelledby="ai-text-tab" tabindex="0">
							<div class="ai-content">
								<div class="d-flex justify-content-between align-items-center mb-3">
									<h3>AI Analysis</h3>
									<button id="regenerateSummaryBtn" class="btn btn-sm btn-outline-primary" data-folder-id="{{ current_folder.id }}">
										<i class="fas fa-sync-alt me-1"></i> Regenerate
									</button>
								</div>
								
								{% if folder_summary %}
								<div id="summaryTimestamp" class="small text-muted mb-3">
									{% if summary_last_updated %}
									Last updated: {{ summary_last_updated.strftime('%Y-%m-%d %H:%M:%S') }}
									{% endif %}
								</div>
								
								<div id="summaryContent">
									<div class="text-section">
										<h5>Summary</h5>
										<div id="summaryText" class="markdown-content">{{ folder_summary|safe }}</div>
									</div>
								</div>
								{% else %}
								<div class="alert alert-info">
									<i class="fas fa-info-circle me-2"></i> No summary available for this folder. Click the "Regenerate" button to create one.
								</div>
								{% endif %}
								
								<!-- Loading spinner (hidden by default) -->
								<div id="summaryLoading" class="text-center py-5 d-none">
									<div class="spinner-border text-primary mb-3" role="status">
										<span class="visually-hidden">Loading...</span>
									</div>
									<p>Generating summary with Gemini 2.0...</p>
									<small class="text-muted">This may take a few moments</small>
								</div>
								
								<!-- Error message (hidden by default) -->
								<div id="summaryError" class="alert alert-danger d-none">
									<div id="errorMessage" class="markdown-content"></div>
								</div>
							</div>
						</div>
					</div>
					{% else %}
					<!-- Regular display for root folder -->
					{% if subfolders or documents %}
					<!-- Folders Section -->
					{% if subfolders %}
					<div class="mb-4">
						<h6 class="text-muted mb-3">Folders</h6>
						<div class="folder-container">
							{% for folder in subfolders %}
							<div class="folder-link">
								<a
									href="{{ url_for('dashboard.records', folder_id=folder.id) }}"
									class="text-decoration-none w-100"
								>
									<div class="folder-item">
										<div class="folder-icon">
											<i class="fas fa-folder"></i>
										</div>
										<div class="folder-name">{{ folder.name }}</div>
									</div>
								</a>
							</div>
							{% endfor %}
						</div>
					</div>
					{% endif %}

					<!-- Files Section -->
					{% if documents %}
					<div>
						<h6 class="text-muted mb-3">Files</h6>
						<div class="folder-container">
							{% for document in documents %} {% set info =
							document.get_file_info() %}
							<div class="file-item-wrapper">
								<div
									class="file-item"
									data-file-path="{{ info.url_path }}"
									data-filename="{{ info.filename }}"
									data-file-type="{{ info.file_type }}"
									data-file-size="{{ info.file_size }}"
									data-upload-date="{{ info.upload_date }}"
									data-description="{{ info.description }}"
									data-document-id="{{ document.id }}"
								>
									<div class="file-icon">
										{% set file_type = info.file_type.lower() %} {% if file_type
										in ['jpg', 'jpeg', 'png', 'gif'] %}
										<i class="fas fa-file-image"></i>
										{% elif file_type == 'pdf' %}
										<i class="fas fa-file-pdf"></i>
										{% elif file_type in ['doc', 'docx'] %}
										<i class="fas fa-file-word"></i>
										{% elif file_type in ['xls', 'xlsx'] %}
										<i class="fas fa-file-excel"></i>
										{% else %}
										<i class="fas fa-file"></i>
										{% endif %}
									</div>
									<div class="file-name">{{ info.filename }}</div>
									<div class="file-actions">
										<button
											class="btn btn-sm btn-outline-secondary me-1 view-file-btn"
											type="button"
										>
											<i class="fas fa-eye"></i>
										</button>
										<a
											href="{{ info.url_path }}"
											download="{{ info.filename }}"
											class="btn btn-sm btn-outline-primary"
										>
											<i class="fas fa-download"></i>
										</a>
									</div>
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
					{% endif %} 
					{% else %}
					<!-- Empty State -->
					<div class="text-center py-5">
						<div class="mb-3">
							<i class="fas fa-folder-open fa-4x text-muted"></i>
						</div>
						<h5>This folder is empty</h5>
						<p class="text-muted">
							Upload files or create folders to organize your medical records.
						</p>
						<button
							class="btn btn-primary mt-3"
							data-bs-toggle="modal"
							data-bs-target="#uploadModal"
						>
							<i class="fas fa-upload me-2"></i> Upload Files
						</button>
					</div>
					{% endif %}
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<!-- Upload Modal -->
	<div
		class="modal fade"
		id="uploadModal"
		tabindex="-1"
		aria-labelledby="uploadModalLabel"
		aria-hidden="true"
	>
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="uploadModalLabel">Upload Files</h5>
					<button
						type="button"
						class="btn-close"
						data-bs-dismiss="modal"
						aria-label="Close"
					></button>
				</div>
				<div class="modal-body">
					<form
						id="uploadForm"
						action="{{ url_for('dashboard.upload') }}"
						method="POST"
						enctype="multipart/form-data"
					>
						{{ csrf_token() }}
						<input
							type="hidden"
							id="uploadFolderId"
							name="folder_id"
							value="{{ current_folder.id if current_folder else '' }}"
						/>

						<div class="mb-3">
							<label for="createFolder" class="form-label"
								>Create New Folder (Optional)</label
							>
							<input
								type="text"
								class="form-control"
								id="createFolder"
								placeholder="Enter folder name"
							/>
							<div class="form-text">
								Leave empty to upload files to the current folder.
							</div>
						</div>

						<div class="mb-3">
							<label for="fileUpload" class="form-label">Select Files</label>
							<div
								class="drag-drop-area p-4 border rounded text-center"
								id="dragDropArea"
							>
								<i class="fas fa-cloud-upload-alt fa-2x mb-3 text-primary"></i>
								<p>
									Drag & drop files here, or click the button below to select
									files
								</p>
								<input
									type="file"
									id="fileUpload"
									name="files[]"
									multiple
									style="display: none;"
									accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx"
								/>
								<button
									type="button"
									id="browseButton"
									class="btn btn-outline-primary"
									onclick="document.getElementById('fileUpload').click()"
								>
									<i class="fas fa-folder-open me-1"></i> Browse Files
								</button>
							</div>
							<div id="fileList" class="mb-3"></div>
						</div>

						<div id="overallProgressContainer" class="mb-3 d-none">
							<label class="form-label">Upload Progress</label>
							<div class="progress">
								<div
									id="overallProgress"
									class="progress-bar progress-bar-striped progress-bar-animated"
									role="progressbar"
									aria-valuenow="0"
									aria-valuemin="0"
									aria-valuemax="100"
									style="width: 0%"
								>
									0%
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button
						type="button"
						class="btn btn-secondary"
						data-bs-dismiss="modal"
					>
						Cancel
					</button>
					<button type="button" id="uploadButton" class="btn btn-primary">
						Upload Files
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Document Preview Modal -->
	<div
		class="modal fade"
		id="documentPreviewModal"
		tabindex="-1"
		aria-labelledby="documentPreviewModalLabel"
		aria-hidden="true"
	>
		<div class="modal-dialog modal-xl modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="documentPreviewModalLabel">
						Document Preview
					</h5>
					<button
						type="button"
						class="btn-close"
						data-bs-dismiss="modal"
						aria-label="Close"
					></button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-md-8">
							<div
								class="document-preview bg-light rounded p-3 d-flex align-items-center justify-content-center"
							>
								<!-- Image Preview -->
								<div id="imagePreview" class="text-center d-none">
									<img
										id="previewImage"
										src=""
										alt="File Preview"
										class="img-fluid"
									/>
								</div>

								<!-- PDF Preview -->
								<div id="pdfPreview" class="w-100 d-none">
									<iframe
										id="previewPdf"
										src=""
										width="100%"
										height="600"
										frameborder="0"
									></iframe>
								</div>

								<!-- Placeholder for other file types -->
								<div id="previewPlaceholder" class="text-center d-none">
									<div class="file-icon-preview">
										<i class="fas fa-file fa-5x text-muted mb-3"></i>
									</div>
									<h5>Preview not available</h5>
									<p>
										This file type cannot be previewed. Please download the file
										to view it.
									</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="file-metadata">
								<h5 class="mb-3">File Information</h5>
								<div class="file-details">
									<div class="row mb-2">
										<div class="col-4 text-muted">File Name:</div>
										<div class="col-8" id="fileName">-</div>
									</div>
									<div class="row mb-2">
										<div class="col-4 text-muted">Type:</div>
										<div class="col-8" id="fileType">-</div>
									</div>
									<div class="row mb-2">
										<div class="col-4 text-muted">Size:</div>
										<div class="col-8" id="fileSize">-</div>
									</div>
									<div class="row mb-2">
										<div class="col-4 text-muted">Uploaded:</div>
										<div class="col-8" id="uploadDate">-</div>
									</div>
									<div class="row mb-2" id="descriptionRow">
										<div class="col-4 text-muted">Description:</div>
										<div class="col-8" id="fileDescription">-</div>
									</div>
								</div>
								<a
									href="#"
									id="downloadButton"
									download
									class="btn btn-primary w-100 mt-3"
								>
									<i class="fas fa-download me-2"></i> Download File
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<!-- Dependencies in proper order -->
<!-- PDF processor script only if needed -->
{% if viewing_document and viewing_document.file_type.lower() == 'pdf' %}
<script src="{{ url_for('static', filename='js/pdf_processor.js') }}"></script>
{% endif %}

<script>
// Global variables
let selectedFiles = [];
let uploadInProgress = false;
let folderCreationInProgress = false;

// Initialize debug logging
const DEBUG = true;

// Debug logger
function logDebug(message, data = null) {
    if (DEBUG) {
        const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
        if (data) {
            console.log(`[${timestamp}] ðŸ“ ${message}`, data);
        } else {
            console.log(`[${timestamp}] ðŸ“ ${message}`);
        }
    }
}

// Main initialization
document.addEventListener('DOMContentLoaded', function() {
    logDebug('Initializing records page');
    
    // Get required elements
    const fileInput = document.getElementById('fileUpload');
    const fileList = document.getElementById('fileList');
    const uploadButton = document.getElementById('uploadButton');
    const dragDropArea = document.getElementById('dragDropArea');

    // Check for CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]');
    if (!csrfToken) {
        console.error('CSRF token not found in form! File uploads will fail.');
    } else {
        logDebug('CSRF token found', { tokenAvailable: !!csrfToken.value });
    }
    
    // Validate upload form
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        logDebug('Upload form found', { 
            action: uploadForm.action,
            method: uploadForm.method,
            enctype: uploadForm.enctype
        });
    }

    // File selection handler
    if (fileInput) {
        logDebug('File input initialized', { multiple: fileInput.multiple, accept: fileInput.accept });
        
        fileInput.addEventListener('change', function() {
            logDebug('File input change detected', { filesLength: this.files ? this.files.length : 0 });
            
            if (this.files && this.files.length > 0) {
                // Check file types
                const validFiles = Array.from(this.files).filter(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const validExtensions = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'doc', 'docx', 'xls', 'xlsx'];
                    return validExtensions.includes(ext);
                });
                
                if (validFiles.length !== this.files.length) {
                    showMessage(`${this.files.length - validFiles.length} invalid file(s) were removed`, "warning");
                }
                
                logDebug(`${validFiles.length} valid files selected`, {
                    totalFiles: this.files.length,
                    validFiles: validFiles.length,
                    fileTypes: validFiles.map(f => f.name.split('.').pop().toLowerCase())
                });
                
                selectedFiles = validFiles;
                updateFileList();
                showMessage(`${validFiles.length} files selected`, "success");
            } else {
                logDebug('No files selected or file input canceled');
                selectedFiles = [];
                updateFileList();
            }
        });
    }

    // Drag and drop handling
    if (dragDropArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dragDropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dragDropArea.classList.add('highlight');
        }

        function unhighlight() {
            dragDropArea.classList.remove('highlight');
        }

        dragDropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            logDebug('Files dropped', { count: files.length });
            
            if (files.length > 0 && fileInput) {
                // We can't directly set the files to fileInput
                // But we can trigger the change event after keeping the files
                selectedFiles = Array.from(files);
                updateFileList();
                showMessage(`${files.length} files dropped`, "success");
            }
        }
    }

    // Upload button handler
    if (uploadButton) {
        uploadButton.addEventListener('click', function() {
            logDebug('Upload button clicked', { 
                filesSelected: selectedFiles.length,
                uploadInProgress: uploadInProgress
            });
            
            if (!uploadInProgress) {
                uploadFiles();
            } else {
                showMessage('Upload already in progress', 'warning');
            }
        });
    }
});
// Helper function to update file list
function updateFileList() {
    const fileList = document.getElementById('fileList');
    if (!fileList) return;
    
    fileList.innerHTML = '';
    
    if (selectedFiles.length === 0) {
        fileList.innerHTML = '<p class="text-muted">No files selected</p>';
        return;
    }
    
    selectedFiles.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'alert alert-info mb-2 d-flex align-items-center';
        div.innerHTML = `
            <i class="fas fa-file me-2"></i>
            <span class="me-auto">${file.name}</span>
            <span class="badge bg-light text-dark me-2">${formatFileSize(file.size)}</span>
            <button type="button" class="btn-close" aria-label="Remove file"></button>
        `;
        
        div.querySelector('.btn-close').onclick = function() {
            selectedFiles.splice(index, 1);
            updateFileList();
        };
        
        fileList.appendChild(div);
    });
}

// Helper function to format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Helper function to show messages
function showMessage(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}
// Function to handle file uploads
function uploadFiles() {
    if (selectedFiles.length === 0) {
        showMessage('Please select files first', 'warning');
        return;
    }

    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]');
    
    if (!csrfToken || !csrfToken.value) {
        showMessage('CSRF token not found or invalid. Please refresh the page and try again.', 'danger');
        logDebug('CSRF token validation failed', { 
            tokenExists: !!csrfToken,
            tokenValue: csrfToken ? (csrfToken.value ? 'Has value' : 'Empty') : 'No token'
        });
        return;
    }
    
    logDebug('CSRF token validated successfully', { 
        tokenLength: csrfToken.value.length
    });
    
    // Check if we need to create a new folder
    const newFolderName = document.getElementById('createFolder').value.trim();
    
    // Update UI elements
    const uploadButton = document.getElementById('uploadButton');
    const progressContainer = document.getElementById('overallProgressContainer');
    
    // Show loading state
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Preparing upload...';
    
    if (newFolderName) {
        // Check if folder name is valid
        if (newFolderName.length < 1 || newFolderName.length > 50) {
            showMessage('Folder name must be between 1 and 50 characters', 'warning');
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Upload Files';
            return;
        }
        
        // Check if folder creation is already in progress
        if (folderCreationInProgress) {
            showMessage('Folder creation already in progress', 'warning');
            return;
        }
        
        // Set flag to prevent duplicate folder creation attempts
        folderCreationInProgress = true;
        
        // Need to create a folder first, then upload to it
        logDebug('Creating new folder before upload:', newFolderName);
        
        uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating folder...';
        
        createNewFolder(newFolderName)
            .then(folderId => {
                folderCreationInProgress = false;
                if (folderId) {
                    logDebug('Folder created successfully with ID:', folderId);
                    // Clear the folder name input after successful creation
                    document.getElementById('createFolder').value = '';
                    uploadFilesToFolder(folderId);
                } else {
                    logDebug('Folder created but no folder ID returned');
                    showMessage('Failed to create folder. Files will be uploaded to current location.', 'warning');
                    proceedWithUpload();
                }
            })
            .catch(error => {
                folderCreationInProgress = false;
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'Upload Files';
                showMessage('Error creating folder: ' + error.message, 'danger');
                logDebug('Folder creation error:', error);
            });
    } else {
        // Just upload to current folder
        proceedWithUpload();
    }

    // Inner function to handle the actual upload
    function proceedWithUpload() {
        const formData = new FormData();
        
        // Add CSRF token
        formData.append('csrf_token', csrfToken.value);
        
        // Add folder ID if present
        const folderId = document.getElementById('uploadFolderId');
        if (folderId && folderId.value) {
            logDebug('Using folder ID for upload', { folderId: folderId.value });
            formData.append('folder_id', folderId.value);
        } else {
            logDebug('No folder ID specified, uploading to root');
        }

        // Add files to form data
        selectedFiles.forEach(file => {
            formData.append('files[]', file);
        });

        // Update UI for upload process
        uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
        progressContainer.classList.remove('d-none');
        
        // Get the progress bar
        const progressBar = document.getElementById('overallProgress');
        if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.setAttribute('aria-valuenow', 0);
        }

        // Send upload request
        const uploadForm = document.getElementById('uploadForm');
        console.log('Uploading files to:', uploadForm.action);
        
        // Use XMLHttpRequest for upload progress tracking
        const xhr = new XMLHttpRequest();
        
        // Set upload in progress flag
        uploadInProgress = true;
        
        // Set up progress event
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                logDebug(`Upload progress: ${percentComplete}%`, {
                    loaded: formatFileSize(e.loaded),
                    total: formatFileSize(e.total),
                    filesCount: selectedFiles.length
                });
                
                if (progressBar) {
                    progressBar.style.width = percentComplete + '%';
                    progressBar.textContent = percentComplete + '%';
                    progressBar.setAttribute('aria-valuenow', percentComplete);
                    
                    // Update button text with progress
                    if (percentComplete < 100) {
                        uploadButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Uploading ${percentComplete}%`;
                    } else {
                        uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
                    }
                }
            }
        });
        
        // Handle load completion
        xhr.addEventListener('load', function() {
            // Log response information
            logDebug('Upload request completed', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseType: xhr.responseType,
                responseHeaders: xhr.getAllResponseHeaders()
            });
            
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    logDebug('Parsed server response', response);
                    
                    if (response.success) {
                        showMessage('Upload successful!', 'success');
                        logDebug('Upload successful, reloading page in 1.5 seconds');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        const errorMsg = response.message || 'Upload failed';
                        logDebug('Server reported failure', { message: errorMsg, details: response.errors });
                        
                        // Show specific error messages if available
                        if (response.errors && response.errors.length > 0) {
                            showMessage(errorMsg + ': ' + response.errors.join(', '), 'danger');
                        } else {
                            showMessage(errorMsg, 'danger');
                        }
                    }
                } catch (e) {
                    logDebug('Error parsing server response', { 
                        error: e.message,
                        responseText: xhr.responseText.substring(0, 200) + '...' // Log only first 200 chars
                    });
                    showMessage('Error processing server response: ' + e.message, 'danger');
                }
            } else {
                let errorMsg = 'Server error: ' + xhr.status;
                logDebug('Server error response', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText.substring(0, 200) + '...' // Log only first 200 chars
                });
                
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                    
                    if (response.errors && response.errors.length > 0) {
                        errorMsg += ': ' + response.errors.join(', ');
                    }
                } catch (e) {
                    logDebug('Could not parse error response', { error: e.message });
                }
                
                showMessage(errorMsg, 'danger');
            }
            
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Upload Files';
            progressContainer.classList.add('d-none');
            uploadInProgress = false;
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
            logDebug('Network error during upload');
            showMessage('Network error during upload. Please try again.', 'danger');
            
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Upload Files';
            progressContainer.classList.add('d-none');
            uploadInProgress = false;
            
            // Try to recover any information about the failed request
            logDebug('Upload failed with error', {
                status: xhr.status,
                statusText: xhr.statusText || 'No status text',
                responseURL: xhr.responseURL || 'No response URL'
            });
        });
        
        // Handle timeout
        xhr.addEventListener('timeout', function() {
            logDebug('Upload request timed out');
            showMessage('Upload request timed out. Please try again.', 'danger');
            
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Upload Files';
            progressContainer.classList.add('d-none');
            uploadInProgress = false;
        });
        
        // Set timeout (30 seconds for each file is a reasonable default)
        xhr.timeout = 30000 * selectedFiles.length; // 30 seconds per file
        logDebug(`Setting upload timeout to ${xhr.timeout}ms for ${selectedFiles.length} files`);
        
        // Open and send the request
        xhr.open('POST', uploadForm.action, true);
        
        // Set the proper headers
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('X-CSRFToken', csrfToken.value);
        
        xhr.send(formData);
    }

    // Function to upload files to a specific folder
    function uploadFilesToFolder(folderId) {
        // Update the folder ID in the form
        document.getElementById('uploadFolderId').value = folderId;
        console.log('Setting folder ID to:', folderId);
        proceedWithUpload();
    }
}

// Function to create a new folder
function createNewFolder(folderName) {
    logDebug('Creating folder:', folderName);
    
    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]');
    if (!csrfToken) {
        return Promise.reject(new Error('CSRF token not found. Please refresh the page.'));
    }
    
    const currentFolderId = document.getElementById('uploadFolderId').value;
    
    // Create FormData object for the folder creation request
    const formData = new FormData();
    formData.append('csrf_token', csrfToken.value);
    formData.append('folder_name', folderName);
    
    // Add a specific identifier for folder creation requests to distinguish them
    // from file upload requests in the route handler
    formData.append('create_folder', 'true');
    
    // Set parent_id if we're in a subfolder
    if (currentFolderId) {
        formData.append('parent_id', currentFolderId);
    }
    
    // Show a creating folder message
    showMessage(`Creating folder "${folderName}"...`, 'info');
    
    // Return a promise for the folder creation request
    return new Promise((resolve, reject) => {
        // Use XMLHttpRequest for better compatibility
        const xhr = new XMLHttpRequest();
        
        xhr.open('POST', "{{ url_for('dashboard.upload') }}", true);
        
        // Set proper headers
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('X-CSRFToken', csrfToken.value);
        xhr.setRequestHeader('X-Create-Folder', 'true');
        
        // Add response handler
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    
                    if (response.success && response.folder_id) {
                        logDebug(`Folder "${folderName}" created with ID: ${response.folder_id}`);
                        showMessage(`Folder "${folderName}" created successfully`, 'success');
                        resolve(response.folder_id);
                    } else {
                        logDebug('Folder creation failed:', response.message || 'Unknown error');
                        reject(new Error(response.message || 'Failed to create folder'));
                    }
                } catch (error) {
                    logDebug('Error parsing server response:', error);
                    reject(new Error('Error processing server response'));
                }
            } else {
                // Handle HTTP errors
                let errorMessage = `Server error (${xhr.status})`;
                
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.message || errorMessage;
                } catch (e) {
                    // If we can't parse the response, use the status text
                    errorMessage = xhr.statusText || errorMessage;
                }
                
                logDebug('Folder creation HTTP error:', errorMessage);
                reject(new Error(errorMessage));
            }
        };
        
        // Handle network errors
        xhr.onerror = function() {
            logDebug('Network error during folder creation');
            reject(new Error('Network error. Please check your connection and try again.'));
        };
        
        // Handle timeout
        xhr.ontimeout = function() {
            logDebug('Timeout during folder creation');
            folderCreationInProgress = false;
            reject(new Error('Request timed out. Please try again.'));
        };
        
        // Set timeout value
        xhr.timeout = 20000; // 20 seconds timeout
        
        // Handle upload progress (mainly for debugging)
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                logDebug(`Folder creation request progress: ${percentComplete}%`);
            }
        });
        
        // Log request details before sending
        logDebug('Sending folder creation request', {
            url: "{{ url_for('dashboard.upload') }}",
            folderName: folderName,
            currentFolderId: currentFolderId,
            csrfTokenPresent: !!csrfToken.value,
            formDataEntries: Array.from(formData.entries()).map(entry => entry[0])
        });
        
        // Send the request
        xhr.send(formData);
    });
}

// File preview functionality
document.addEventListener('DOMContentLoaded', function() {
    // Get all view file buttons
    const viewButtons = document.querySelectorAll('.view-file-btn');
    
    // Add click handler to each button
    viewButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get the parent file item element that contains all the data attributes
            const fileItem = this.closest('.file-item');
            if (!fileItem) return;
            
            // Extract file information from data attributes
            const filePath = fileItem.dataset.filePath;
            const fileName = fileItem.dataset.filename;
            const fileType = fileItem.dataset.fileType;
            const fileSize = fileItem.dataset.fileSize;
            const uploadDate = fileItem.dataset.uploadDate;
            const description = fileItem.dataset.description;
            const documentId = fileItem.dataset.documentId;
            
            // Show the preview modal
            showFilePreview(filePath, fileName, fileType, fileSize, uploadDate, description, documentId);
        });
    });
});

/**
 * Shows the file preview modal with the appropriate content based on file type
 */
function showFilePreview(filePath, fileName, fileType, fileSize, uploadDate, description, documentId) {
    // Get modal elements
    const modal = document.getElementById('documentPreviewModal');
    if (!modal) return;
    
    // Get preview containers
    const imagePreview = document.getElementById('imagePreview');
    const pdfPreview = document.getElementById('pdfPreview');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    
    // Get file metadata elements
    const fileNameElement = document.getElementById('fileName');
    const fileTypeElement = document.getElementById('fileType');
    const fileSizeElement = document.getElementById('fileSize');
    const uploadDateElement = document.getElementById('uploadDate');
    const fileDescriptionElement = document.getElementById('fileDescription');
    const descriptionRow = document.getElementById('descriptionRow');
    
    // Get download button
    const downloadButton = document.getElementById('downloadButton');
    
    // Hide all preview containers initially
    imagePreview.classList.add('d-none');
    pdfPreview.classList.add('d-none');
    previewPlaceholder.classList.add('d-none');
    
    // Update file metadata
    if (fileNameElement) fileNameElement.textContent = fileName || '-';
    if (fileTypeElement) fileTypeElement.textContent = fileType ? fileType.toUpperCase() : '-';
    if (fileSizeElement) fileSizeElement.textContent = formatFileSize(parseInt(fileSize, 10)) || '-';
    if (uploadDateElement) uploadDateElement.textContent = uploadDate || '-';
    
    // Handle description
    if (fileDescriptionElement) {
        if (description && description.trim() !== '') {
            fileDescriptionElement.textContent = description;
            if (descriptionRow) descriptionRow.classList.remove('d-none');
        } else {
            fileDescriptionElement.textContent = '-';
            if (descriptionRow) descriptionRow.classList.add('d-none');
        }
    }
    
    // Set download button URL
    if (downloadButton) {
        downloadButton.href = filePath;
        downloadButton.setAttribute('download', fileName);
    }
    
    // Set modal title
    const modalTitle = modal.querySelector('.modal-title');
    if (modalTitle) modalTitle.textContent = fileName || 'Document Preview';
    
    // Determine the file type and show appropriate preview
    const lowerFileType = fileType ? fileType.toLowerCase() : '';
    
    if (lowerFileType === 'pdf') {
        // PDF preview
        const pdfFrame = document.getElementById('previewPdf');
        if (pdfFrame) {
            pdfFrame.src = filePath;
            pdfFrame.onerror = function() {
                pdfPreview.classList.add('d-none');
                previewPlaceholder.classList.remove('d-none');
                showMessage('Failed to load PDF preview', 'warning');
            };
            pdfPreview.classList.remove('d-none');
        }
    } else if (['jpg', 'jpeg', 'png', 'gif'].includes(lowerFileType)) {
        // Image preview
        const imgElement = document.getElementById('previewImage');
        if (imgElement) {
            imgElement.src = filePath;
            imgElement.alt = fileName;
            imgElement.onerror = function() {
                imagePreview.classList.add('d-none');
                previewPlaceholder.classList.remove('d-none');
                showMessage('Failed to load image preview', 'warning');
            };
            imagePreview.classList.remove('d-none');
        }
    } else {
        // Other file types - show placeholder
        previewPlaceholder.classList.remove('d-none');
        
        // Update the placeholder icon based on file type
        const placeholderIcon = previewPlaceholder.querySelector('.fa-file');
        if (placeholderIcon) {
            placeholderIcon.className = 'fas fa-5x mb-3 ';
            
            if (lowerFileType === 'docx' || lowerFileType === 'doc') {
                placeholderIcon.className += 'fa-file-word text-primary';
            } else if (lowerFileType === 'xlsx' || lowerFileType === 'xls') {
                placeholderIcon.className += 'fa-file-excel text-success';
            } else {
                placeholderIcon.className += 'fa-file text-muted';
            }
        }
    }
    
    // Alternative approach: Fetch file preview from server if needed
    if (documentId && (lowerFileType === 'pdf' || ['jpg', 'jpeg', 'png', 'gif'].includes(lowerFileType))) {
        const previewUrl = `/dashboard/preview/${documentId}`;
        console.log(`Preview URL: ${previewUrl}`);
        
        // You can add AJAX call here if you need to fetch preview from server
        // This is useful if you need to generate previews on-demand
        // fetch(previewUrl)
        //     .then(response => {
        //         if (!response.ok) throw new Error('Failed to load preview');
        //         return response;
        //     })
        //     .catch(error => {
        //         console.error('Error loading preview:', error);
        //         imagePreview.classList.add('d-none');
        //         pdfPreview.classList.add('d-none');
        //         previewPlaceholder.classList.remove('d-none');
        //         showMessage('Failed to load preview', 'warning');
        //     });
    }
    
    // Show the modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}
</script>
<!-- Include folder summary script -->
<script src="{{ url_for('static', filename='js/folder_summary.js') }}"></script>
{% endblock %}
